<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Prompt Hub Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        /* --- CORE STYLES --- */
        body {
            background-color: #0F172A;
            color: #E2E8F0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            overflow-x: hidden;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .view-section { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .active-view { display: block; opacity: 1; transform: translateY(0); }
        
        /* Skeleton & Loading */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Search Animation - FASTER NOW */
        #search-wrapper {
            max-height: 0; opacity: 0; overflow: hidden; transform: translateY(-5px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); margin-bottom: 0;
        }
        #search-wrapper.search-active {
            max-height: 60px; opacity: 1; transform: translateY(0); margin-bottom: 0.5rem;
        }

        /* Premium & Badges */
        .premium-border {
            border: 1px solid rgba(245, 158, 11, 0.5);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.1);
        }
        .premium-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #4c1d00;
        }

        /* Referral Box */
        .ref-box {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 1px solid rgba(56, 189, 248, 0.2);
        }
    </style>
</head>
<body class="min-h-screen selection:bg-cyan-500/30">

    <nav class="sticky top-0 z-30 px-4 py-3 flex items-center justify-between bg-[#0F172A]/90 backdrop-blur-md border-b border-white/5">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-tr from-cyan-600 to-blue-600 flex items-center justify-center shadow-lg shadow-cyan-900/20 border border-white/10 relative overflow-hidden">
                <div class="absolute inset-0 bg-white/20 blur-sm"></div>
                <i class="fa-solid fa-bolt text-sm text-white relative z-10"></i>
            </div>
            <div>
                <h1 class="font-bold text-base tracking-wide text-slate-100 leading-tight">Prompt<span class="text-cyan-400">Hub</span></h1>
                <div class="flex items-center gap-1">
                    <span class="text-[10px] text-slate-500 font-medium" id="user-status-badge">Free</span>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <button onclick="toggleSearchBar()" class="w-9 h-9 rounded-full bg-slate-800/80 border border-slate-700/50 flex items-center justify-center text-slate-400 active:bg-slate-700 transition-colors">
                <i class="fa-solid fa-magnifying-glass text-xs"></i>
            </button>
            <div onclick="openCoinModal()" class="flex items-center gap-2 bg-slate-800/80 rounded-full pl-2 pr-3 py-1.5 border border-amber-500/30 cursor-pointer active:scale-95 transition-transform shadow-[0_0_10px_rgba(245,158,11,0.1)]">
                <div class="w-5 h-5 rounded-full bg-amber-500 flex items-center justify-center shadow-sm">
                    <i class="fa-solid fa-coins text-[10px] text-amber-950"></i>
                </div>
                <span id="user-coins" class="text-xs font-bold text-amber-400">0</span>
            </div>
        </div>
    </nav>

    <div id="view-home" class="view-section active-view">
        <div class="px-4 pt-4 pb-2 sticky top-[60px] z-20 bg-[#0F172A]/95 backdrop-blur-xl">
            <div id="search-wrapper" class="relative group">
                <i class="fa-solid fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-500 text-xs transition-colors"></i>
                <input type="text" id="search-input" oninput="window.liveSearch()" placeholder="Search prompts..." 
                    class="w-full bg-[#1E293B] text-slate-200 text-xs rounded-xl py-3 pl-10 pr-4 focus:outline-none focus:ring-1 focus:ring-cyan-500/50 transition-all border border-slate-700/50 placeholder-slate-500">
            </div>
            <div class="pt-1 pb-1 overflow-x-auto no-scrollbar flex items-center gap-2" id="category-container"></div>
        </div>
        
        <main class="px-4 mt-2 pb-24 min-h-[60vh]">
            <div id="trending-section" class="mb-6 hidden">
                <div class="flex items-center justify-between mb-3 px-1">
                    <h2 class="text-sm font-bold text-white flex items-center gap-2">
                        <i class="fa-solid fa-fire text-orange-500"></i> Popular Now
                    </h2>
                </div>
                <div id="trending-container" class="flex overflow-x-auto gap-3 no-scrollbar pb-2"></div>
            </div>

            <h2 class="text-sm font-bold text-white mb-3 px-1 flex items-center gap-2">
                <i class="fa-solid fa-layer-group text-cyan-500"></i> All Prompts
            </h2>
            <div id="prompts-grid" class="grid grid-cols-2 gap-3"> <div class="aspect-[3/4] rounded-xl skeleton"></div>
                <div class="aspect-[3/4] rounded-xl skeleton"></div>
            </div>
            
            <div id="no-results" class="hidden flex-col items-center justify-center py-16 text-slate-500">
                <i class="fa-solid fa-ghost text-3xl mb-3 opacity-50"></i>
                <p class="text-xs">No prompts found</p>
            </div>
        </main>
    </div>

    <div id="view-earn" class="view-section px-4 pt-6 pb-24">
        <div class="text-center mb-8">
            <div class="text-xs text-slate-400 font-bold uppercase tracking-wider mb-2">My Balance</div>
            <h2 class="text-4xl font-bold text-white flex items-center justify-center gap-2">
                <i class="fa-solid fa-coins text-amber-400 text-2xl"></i> <span id="earn-balance">0</span>
            </h2>
            <p class="text-[10px] text-slate-500 mt-2">Earn more coins by referring friends!</p>
        </div>

        <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold text-white pl-1 border-l-4 border-cyan-500 pl-2">Premium Plans</h3>
        </div>

        <div class="space-y-4">
            <div onclick="buyPlan(1, 200)" class="bg-[#1E293B] p-5 rounded-2xl border border-slate-700 relative overflow-hidden active:scale-[0.98] transition-all">
                <div class="flex items-center justify-between relative z-10">
                    <div>
                        <h4 class="text-lg font-bold text-white">24 Hours Access</h4>
                        <p class="text-[10px] text-slate-400">Unlock All Premium Prompts</p>
                    </div>
                    <div class="text-xl font-bold text-amber-400">200 <i class="fa-solid fa-coins text-sm"></i></div>
                </div>
            </div>

            <div onclick="buyPlan(7, 1000)" class="bg-gradient-to-r from-amber-900/20 to-orange-900/20 p-5 rounded-2xl border border-amber-500/50 relative overflow-hidden active:scale-[0.98] transition-all">
                <div class="absolute top-0 right-0 bg-amber-500 text-[9px] text-black font-bold px-3 py-1 rounded-bl-xl">BEST VALUE</div>
                <div class="flex items-center justify-between relative z-10">
                    <div>
                        <h4 class="text-lg font-bold text-white">7 Days Access</h4>
                        <p class="text-[10px] text-amber-200/70">Weekly VIP Pass</p>
                    </div>
                    <div class="text-xl font-bold text-amber-400">1000 <i class="fa-solid fa-coins text-sm"></i></div>
                </div>
            </div>
        </div>
        
        <div class="mt-8 text-center">
            <button onclick="switchTab('home'); setTimeout(()=>{window.scrollTo(0,0)},100)" class="text-xs text-cyan-400 font-bold hover:underline">
                View All Premium Prompts <i class="fa-solid fa-arrow-right ml-1"></i>
            </button>
        </div>
    </div>

    <div id="view-saved" class="view-section px-4 pt-4 pb-24">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-bold text-white">Favorites</h2>
        </div>
        <div id="saved-list" class="space-y-3"></div>
        <div id="saved-empty" class="hidden flex-col items-center justify-center py-20 text-slate-600">
            <i class="fa-regular fa-bookmark text-4xl mb-4 opacity-40"></i>
            <p class="text-xs">Your collection is empty.</p>
        </div>
    </div>

    <div id="view-profile" class="view-section px-4 pt-8 pb-24 text-center">
        <div class="relative inline-block mb-3">
            <img id="profile-img" src="https://ui-avatars.com/api/?name=User&background=1e293b&color=94a3b8" class="w-20 h-20 rounded-full border-4 border-[#1E293B] shadow-2xl bg-[#1E293B]">
            <div id="profile-badge" class="hidden absolute -bottom-1 -right-1 w-8 h-8 bg-gradient-to-r from-amber-400 to-orange-500 rounded-full flex items-center justify-center border-4 border-[#0F172A] shadow-lg">
                <i class="fa-solid fa-crown text-[12px] text-white"></i>
            </div>
        </div>
        <h2 id="profile-name" class="text-lg font-bold text-white">Guest</h2>
        <div id="sub-status" class="text-xs text-slate-500 mt-1 mb-4">No active plan</div>
        
        <button onclick="window.open('https://t.me/mdnahid44', '_blank')" class="w-full mb-6 py-3 rounded-xl bg-[#229ED9]/10 border border-[#229ED9]/30 text-[#229ED9] font-bold text-xs flex items-center justify-center gap-2 active:scale-95 transition-transform">
            <i class="fa-brands fa-telegram text-lg"></i> Join Our Telegram Channel
        </button>

        <div class="ref-box rounded-2xl p-5 mb-6 text-left relative overflow-hidden">
            <div class="absolute -right-4 -top-4 w-20 h-20 bg-cyan-500/20 blur-2xl rounded-full"></div>
            
            <div class="flex items-center justify-between mb-4 relative z-10">
                <h3 class="text-sm font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-users text-cyan-400"></i> Referral System
                </h3>
                <span class="text-[10px] bg-cyan-500/10 text-cyan-300 px-2 py-1 rounded border border-cyan-500/20">
                    Get <span id="ref-reward-display">50</span> Coins / Invite
                </span>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-4 relative z-10">
                <div class="bg-[#0F172A]/50 p-3 rounded-xl border border-slate-700/50">
                    <div class="text-[10px] text-slate-400 mb-1">Total Invites</div>
                    <div class="text-lg font-bold text-white" id="ref-count">0</div>
                </div>
                <div class="bg-[#0F172A]/50 p-3 rounded-xl border border-slate-700/50">
                    <div class="text-[10px] text-slate-400 mb-1">Total Earned</div>
                    <div class="text-lg font-bold text-amber-400 flex items-center gap-1">
                        <i class="fa-solid fa-coins text-[10px]"></i> <span id="ref-earnings">0</span>
                    </div>
                </div>
            </div>

            <button onclick="copyRefLink()" class="relative z-10 w-full py-3 rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 text-white font-bold text-xs shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i class="fa-regular fa-copy"></i> Copy Referral Link
            </button>
            <div id="ref-link" class="hidden"></div>
        </div>

        <div class="space-y-3 mb-6">
            <button onclick="document.getElementById('about-modal').classList.remove('hidden')" class="w-full bg-[#1E293B] p-3 rounded-xl border border-slate-700/50 flex items-center justify-between active:scale-[0.98] transition-transform">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-cyan-500/10 flex items-center justify-center"><i class="fa-solid fa-user-tie text-cyan-400 text-xs"></i></div>
                    <span class="text-xs font-bold text-slate-200">About Creator</span>
                </div>
                <i class="fa-solid fa-chevron-right text-slate-600 text-[10px]"></i>
            </button>
        </div>
    </div>

    <div id="unlock-modal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center bg-black/80 hidden backdrop-blur-sm">
        <div class="bg-[#1E293B] w-full max-w-sm rounded-t-2xl sm:rounded-2xl p-6 border-t sm:border border-slate-700 shadow-2xl animate__animated animate__slideInUp animate__faster">
            <div class="text-center">
                <div class="w-16 h-16 bg-cyan-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-cyan-500/20">
                    <i class="fa-solid fa-lock text-2xl text-cyan-400"></i>
                </div>
                <h3 class="text-lg font-bold text-white mb-1">Unlock This Prompt</h3>
                <p class="text-xs text-slate-400 mb-6 px-4">Buy Premium or Watch Ad to unlock.</p>

                <div class="space-y-3">
                    <button id="btn-watch-ad" onclick="triggerDynamicAd(false)" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-cyan-600 to-blue-600 text-white text-xs font-bold shadow-lg shadow-cyan-900/40 active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-video"></i> Watch Ad (Free)
                    </button>
                    
                    <button onclick="document.getElementById('unlock-modal').classList.add('hidden'); switchTab('earn');" class="w-full py-3.5 rounded-xl bg-[#0F172A] border border-amber-500/30 text-amber-400 text-xs font-bold hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-crown"></i> Buy Premium Plan
                    </button>
                    
                    <button onclick="document.getElementById('unlock-modal').classList.add('hidden')" class="text-[10px] text-slate-500 p-2">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-view" class="fixed inset-0 z-50 bg-[#0F172A] overflow-y-auto hidden animate__animated animate__fadeInRight animate__faster">
        <div class="relative w-full h-[45vh]">
            <img id="d-img" src="" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-[#0F172A]"></div>
            <button onclick="closeDetails()" class="absolute top-4 left-4 w-10 h-10 rounded-full bg-black/40 backdrop-blur-md flex items-center justify-center text-white border border-white/10 active:scale-90 transition-transform">
                <i class="fa-solid fa-arrow-left text-sm"></i>
            </button>
            <button onclick="toggleLikeFromDetail()" id="d-like-btn" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-black/40 backdrop-blur-md flex items-center justify-center text-white border border-white/10 active:scale-90 transition-transform">
                <i class="fa-regular fa-heart text-sm"></i>
            </button>
        </div>
        
        <div class="px-6 -mt-12 relative z-10 pb-10">
            <div class="flex items-center gap-2 mb-3">
                <span id="d-cat" class="text-[10px] font-bold bg-cyan-500/10 text-cyan-400 px-3 py-1 rounded-lg border border-cyan-500/20 backdrop-blur-md">CATEGORY</span>
                <span id="d-views" class="text-[10px] text-slate-300 bg-black/50 px-2 py-1 rounded-lg backdrop-blur-md border border-white/5">
                    <i class="fa-solid fa-eye text-[9px] mr-1"></i> 0 views
                </span>
            </div>
            
            <h1 id="d-title" class="text-2xl font-bold text-white mb-5 leading-tight shadow-black drop-shadow-lg">Prompt Title</h1>
            
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">The Prompt</span>
                    <button onclick="copyPrompt()" class="text-cyan-400 text-[10px] font-bold flex items-center gap-1 bg-cyan-500/10 px-2 py-1 rounded border border-cyan-500/20 active:scale-95 transition-transform">
                        <i class="fa-regular fa-copy"></i> Copy
                    </button>
                </div>
                <div class="bg-[#1E293B] border border-slate-700/50 rounded-xl p-4 relative font-mono text-xs text-slate-300 leading-relaxed max-h-60 overflow-y-auto">
                    <p id="d-prompt">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800/90 backdrop-blur-md border border-emerald-500/30 text-emerald-400 px-5 py-3 rounded-2xl text-xs font-bold shadow-2xl flex items-center gap-2 transition-all duration-300 opacity-0 translate-y-[-20px] z-[90]">
        <i class="fa-solid fa-circle-check"></i>
        <span id="toast-msg">Success!</span>
    </div>

    <div id="about-modal" class="fixed inset-0 z-[100] bg-[#0F172A] flex flex-col items-center justify-center hidden animate__animated animate__fadeIn">
        <button onclick="document.getElementById('about-modal').classList.add('hidden')" class="absolute top-5 left-5 w-10 h-10 rounded-full bg-[#1E293B] border border-slate-700 text-white flex items-center justify-center">
            <i class="fa-solid fa-arrow-left"></i>
        </button>
        <div class="text-center p-6 w-full max-w-sm">
            <div class="w-32 h-32 mx-auto rounded-full p-1 bg-gradient-to-tr from-cyan-400 via-blue-500 to-purple-600 mb-5 relative">
                <img src="https://i.ibb.co.com/DPP2QNCh/20251230-173236.jpg" onerror="this.src='https://ui-avatars.com/api/?name=Nahidul+Islam&background=random'" class="w-full h-full rounded-full object-cover border-4 border-[#0F172A]">
            </div>
            <h1 class="text-2xl font-bold text-white tracking-wide mb-1 font-serif">NAHIDUL ISLAM</h1>
            <p class="text-cyan-400 text-xs font-bold uppercase tracking-widest mb-4">Admin & Developer</p>
            <button onclick="window.open('https://t.me/mdnahid44', '_blank')" class="w-full py-3.5 rounded-xl bg-gradient-to-r from-[#229ED9] to-[#0088cc] text-white font-bold text-sm shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                <i class="fa-brands fa-telegram text-lg"></i> Contact on Telegram
            </button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 w-full glass z-40 pb-safe">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="switchTab('home')" class="nav-btn active text-cyan-400 flex flex-col items-center gap-1 w-14 py-1 rounded-xl transition-all" data-target="view-home">
                <i class="fa-solid fa-house text-lg mb-0.5 transition-transform group-active:scale-90"></i>
                <span class="text-[9px] font-medium">Home</span>
            </button>
            
            <button onclick="switchTab('saved')" class="nav-btn text-slate-500 flex flex-col items-center gap-1 w-14 py-1 rounded-xl transition-all hover:bg-white/5" data-target="view-saved">
                <i class="fa-solid fa-bookmark text-lg mb-0.5 transition-transform group-active:scale-90"></i>
                <span class="text-[9px] font-medium">Saved</span>
            </button>
            
            <button onclick="switchTab('earn')" class="nav-btn text-slate-500 flex flex-col items-center gap-1 w-14 py-1 rounded-xl transition-all hover:bg-amber-900/20" data-target="view-earn">
                <div class="relative">
                    <i class="fa-solid fa-store text-lg mb-0.5 transition-transform group-active:scale-90"></i>
                </div>
                <span class="text-[9px] font-bold">Store</span>
            </button>
            
            <button onclick="switchTab('profile')" class="nav-btn text-slate-500 flex flex-col items-center gap-1 w-14 py-1 rounded-xl transition-all hover:bg-white/5" data-target="view-profile">
                <i class="fa-solid fa-user text-lg mb-0.5 transition-transform group-active:scale-90"></i>
                <span class="text-[9px] font-medium">Profile</span>
            </button>
        </div>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAMbafYsnv4VI0zYrQnQ-hHfAZ3ImlJo6U",
            authDomain: "crashgame-a8f75.firebaseapp.com",
            projectId: "crashgame-a8f75",
            storageBucket: "crashgame-a8f75.firebasestorage.app",
            messagingSenderId: "1020125744751",
            appId: "1:1020125744751:web:97128d1d868f4907b9c79a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE
        let currentUser = null; 
        let userDocData = null;
        let prompts = [];
        let displayedPrompts = [];
        let pendingUnlockId = null;
        
        // DYNAMIC CONFIG (Default Values Updated)
        let adZoneId = '10312256';
        let referralReward = 50; // DEFAULT REDUCED
        let adReward = 5; // UPDATED TO 5 COINS

        const BOT_USERNAME = "KachaKolaBot"; 

        // --- DYNAMIC AD LOADER ---
        async function loadAppConfig() {
            try {
                const configRef = doc(db, "settings", "config");
                const configSnap = await getDoc(configRef);

                if (configSnap.exists()) {
                    const data = configSnap.data();
                    adZoneId = data.zoneId || '10312256';
                    referralReward = data.referralReward || 50;
                    adReward = data.adReward || 5;
                } else {
                    await setDoc(configRef, {
                        zoneId: '10312256',
                        referralReward: 50,
                        adReward: 5
                    });
                }
                
                document.getElementById('ref-reward-display').textContent = referralReward;

                const script = document.createElement('script');
                script.src = '//libtl.com/sdk.js';
                script.dataset.zone = adZoneId;
                script.dataset.sdk = `show_${adZoneId}`;
                document.head.appendChild(script);

            } catch (e) {
                console.error("Config Load Error:", e);
                const script = document.createElement('script');
                script.src = '//libtl.com/sdk.js';
                script.dataset.zone = '10312256';
                script.dataset.sdk = 'show_10312256';
                document.head.appendChild(script);
            }
        }

        // --- AD TRIGGER FUNCTION ---
        window.triggerDynamicAd = (forCoins = false) => {
            // Note: Ad for Coins button removed from UI, this logic persists for safety/fallback
            document.getElementById('unlock-modal').classList.add('hidden');
            const sdkFuncName = `show_${adZoneId}`;
            
            if (typeof window[sdkFuncName] === 'function') {
                window[sdkFuncName]().then(() => {
                    handleAdSuccess(forCoins);
                });
            } else {
                setTimeout(() => handleAdSuccess(forCoins), 2000);
            }
        };

        async function handleAdSuccess(forCoins) {
            showToast("Verifying Ad...", "neutral");
            setTimeout(async () => {
                if (forCoins) {
                    await updateDoc(doc(db, "users", currentUser.uid), { coins: increment(adReward) });
                    showToast(`+${adReward} Coins Added!`, "success");
                } else {
                     const updates = {};
                    updates[`unlockedTimestamps.${pendingUnlockId}`] = Date.now();
                    await updateDoc(doc(db, "users", currentUser.uid), updates);
                    showToast("Unlocked successfully!", "success");
                    setTimeout(() => openDetails(pendingUnlockId), 500);
                }
            }, 3000);
        }

        // --- APP INIT ---
        window.toggleSearchBar = () => {
            const wrapper = document.getElementById('search-wrapper');
            const input = document.getElementById('search-input');
            const isActive = wrapper.classList.contains('search-active');
            
            if (isActive) {
                wrapper.classList.remove('search-active');
                input.blur();
            } else {
                wrapper.classList.add('search-active');
                setTimeout(() => input.focus(), 50); // Faster focus
            }
        };

        window.liveSearch = () => {
            const activeBtn = document.querySelector('.cat-btn[class*="text-cyan-400"]');
            const currentCat = activeBtn ? activeBtn.dataset.cat : 'All';
            window.filterCat(currentCat);
        };

        function initApp() {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            tg.setHeaderColor('#0F172A');
            tg.setBackgroundColor('#0F172A');

            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                const u = tg.initDataUnsafe.user;
                const startParam = tg.initDataUnsafe.start_param;
                let referrerId = null;
                if(startParam && startParam.startsWith("ref_")) {
                    referrerId = startParam.split("_")[1];
                }

                currentUser = {
                    uid: String(u.id),
                    first_name: u.first_name,
                    username: u.username || 'No Username',
                    photo_url: u.photo_url || null,
                    referrerId: referrerId
                };
            } else {
                currentUser = { uid: 'guest_dev_v4', first_name: 'Guest', username: 'guest', isGuest: true };
            }

            loadAppConfig().then(() => {
                syncUserToFirestore();
            });
            
            fetchPrompts();
        }

        function syncUserToFirestore() {
            const userRef = doc(db, "users", currentUser.uid);
            onSnapshot(userRef, async (docSnap) => {
                if (docSnap.exists()) {
                    userDocData = docSnap.data();
                } else {
                    const newUserData = {
                        uid: currentUser.uid,
                        firstName: currentUser.first_name,
                        username: currentUser.username,
                        referralCount: 0,
                        referralEarnings: 0,
                        coins: 20, // Starting coins
                        favorites: [],
                        unlockedTimestamps: {}, 
                        premiumExpiry: 0,
                        referredBy: currentUser.referrerId || null,
                        hasConverted: false,
                        joinedAt: Date.now()
                    };
                    await setDoc(userRef, newUserData);
                    userDocData = newUserData;
                    
                    if (currentUser.referrerId && currentUser.referrerId !== currentUser.uid) {
                        try {
                            const inviterRef = doc(db, "users", currentUser.referrerId);
                            await updateDoc(inviterRef, {
                                coins: increment(referralReward),
                                referralCount: increment(1),
                                referralEarnings: increment(referralReward)
                            });
                        } catch(e) { console.log("Referral Error", e); }
                    }

                    showToast("Welcome! You got 20 Coins!", "success");
                }
                updateUI();
            });
        }

        function fetchPrompts() {
            const promptsCol = collection(db, "prompts");
            onSnapshot(promptsCol, (snapshot) => {
                prompts = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        id: doc.id, 
                        ...data,
                        uploadDate: data.uploadDate || Date.now(),
                        unlockCount: data.unlockCount || 0 
                    };
                });
                displayedPrompts = prompts;
                const cats = ["All", ...new Set(prompts.map(p => p.category))];
                document.getElementById('category-container').innerHTML = cats.map(c => 
                    `<button onclick="window.filterCat('${c}')" class="cat-btn px-4 py-2 rounded-xl text-[11px] font-bold bg-[#1E293B] text-slate-400 border border-slate-700/50 hover:border-cyan-500/50 transition-all whitespace-nowrap ${c === 'All' ? 'bg-gradient-to-r from-cyan-900/50 to-blue-900/50 text-cyan-400 border-cyan-500/50' : ''}" data-cat="${c}">${c}</button>`
                ).join('');
                renderHome();
                renderSaved();
            });
        }

        function renderHome() {
            const isPremiumUser = userDocData?.premiumExpiry > Date.now();
            const trending = [...prompts].sort((a, b) => b.unlockCount - a.unlockCount).slice(0, 6);
            if(trending.length > 0 && trending[0].unlockCount > 0) {
                document.getElementById('trending-section').classList.remove('hidden');
                document.getElementById('trending-container').innerHTML = trending.map(p => `
                    <div onclick="window.checkAccess('${p.id}')" class="min-w-[150px] h-[200px] rounded-xl relative overflow-hidden flex-shrink-0 border border-amber-500/30">
                        <img src="${p.image}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                        <div class="absolute top-2 right-2 px-1.5 py-0.5 bg-black/60 rounded text-[9px] text-white font-bold backdrop-blur-md border border-white/10">
                            <i class="fa-solid fa-fire text-orange-500"></i> ${p.unlockCount}
                        </div>
                        <div class="absolute bottom-2 left-2 right-2">
                             <div class="text-[11px] font-bold text-white truncate leading-tight">${p.title}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('trending-section').classList.add('hidden');
            }

            const grid = document.getElementById('prompts-grid');
            if(displayedPrompts.length === 0) {
                grid.innerHTML = '';
                document.getElementById('no-results').classList.remove('hidden'); document.getElementById('no-results').classList.add('flex');
                return;
            }
            document.getElementById('no-results').classList.add('hidden'); document.getElementById('no-results').classList.remove('flex');
            
            const searchVal = document.getElementById('search-input').value.toLowerCase();

            grid.innerHTML = displayedPrompts.map(item => {
                if(searchVal && !item.title.toLowerCase().includes(searchVal)) return ''; 
                
                const isFav = userDocData?.favorites?.includes(item.id);
                const isIndividuallyUnlocked = (userDocData?.unlockedTimestamps?.[item.id] || 0) + (24*60*60*1000) > Date.now();
                const isUnlocked = isPremiumUser || isIndividuallyUnlocked;
                
                // UPDATED LOCK UI - Only Icons, Small, Clean
                return `
                <div class="group relative aspect-[3/4] bg-[#1E293B] rounded-xl overflow-hidden shadow-lg border ${item.isPremium ? 'premium-border' : 'border-slate-700/50'} transition-all hover:border-cyan-500/30">
                    <img onclick="window.checkAccess('${item.id}')" src="${item.image}" class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-all duration-500 group-hover:scale-105">
                    
                    <div class="absolute top-2 left-2 bg-black/50 backdrop-blur-sm px-2 py-0.5 rounded text-[8px] font-bold text-white border border-white/10 z-10">
                        <i class="fa-solid fa-eye text-cyan-400 mr-1"></i> ${item.unlockCount}
                    </div>

                    ${item.isPremium ? `<div class="absolute top-2 right-12 premium-badge px-2 py-0.5 rounded text-[8px] font-bold shadow-sm z-10"><i class="fa-solid fa-crown mr-1"></i>PRO</div>` : ''}
                    
                    <button onclick="toggleFav(event, '${item.id}')" class="absolute top-2 right-2 w-7 h-7 rounded-full bg-black/40 backdrop-blur-md flex items-center justify-center border border-white/10 z-10 active:scale-90">
                        <i class="${isFav ? 'fa-solid text-rose-500' : 'fa-regular text-white'} fa-heart text-xs"></i>
                    </button>

                    <div onclick="window.checkAccess('${item.id}')" class="absolute inset-0 bg-gradient-to-t from-[#0F172A] via-transparent to-transparent"></div>
                    
                    <div onclick="window.checkAccess('${item.id}')" class="absolute bottom-0 left-0 w-full p-3 flex items-end justify-between">
                        <h3 class="text-[13px] font-semibold text-slate-100 leading-tight truncate w-3/4">${item.title}</h3>
                        
                        ${!isUnlocked ? 
                            `<div class="w-7 h-7 rounded-full bg-slate-900/80 backdrop-blur border border-white/10 flex items-center justify-center text-slate-400 shadow-md">
                                <i class="fa-solid fa-lock text-[10px]"></i>
                             </div>` : 
                            `<div class="w-7 h-7 rounded-full bg-emerald-500/20 backdrop-blur border border-emerald-500/30 flex items-center justify-center text-emerald-400 shadow-md">
                                <i class="fa-solid fa-unlock-keyhole text-[10px]"></i>
                             </div>`
                        }
                    </div>
                </div>`;
            }).join('');
        }

        function renderSaved() {
            const list = document.getElementById('saved-list');
            const items = prompts.filter(p => userDocData?.favorites?.includes(p.id));
            if(items.length === 0) {
                list.innerHTML = '';
                document.getElementById('saved-empty').classList.remove('hidden'); document.getElementById('saved-empty').classList.add('flex');
                return;
            }
            document.getElementById('saved-empty').classList.add('hidden'); document.getElementById('saved-empty').classList.remove('flex');
            list.innerHTML = items.map(item => `
                <div onclick="window.checkAccess('${item.id}')" class="flex items-center gap-3 bg-[#1E293B] p-2 rounded-xl border border-slate-700/50 active:scale-[0.98] transition-all">
                    <img src="${item.image}" class="w-14 h-14 rounded-lg object-cover bg-slate-800">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-xs font-bold text-slate-200 truncate mb-1">${item.title}</h4>
                        <div class="flex items-center gap-2">
                             <span class="text-[10px] text-slate-500 bg-slate-800 px-1.5 py-0.5 rounded">${item.category}</span>
                             <span class="text-[9px] text-slate-400"><i class="fa-solid fa-eye mr-0.5"></i> ${item.unlockCount}</span>
                        </div>
                    </div>
                    <div class="px-3"><i class="fa-solid fa-chevron-right text-[10px] text-slate-600"></i></div>
                </div>
            `).join('');
        }

        window.checkAccess = (id) => {
            const isPremium = userDocData?.premiumExpiry > Date.now();
            const isUnlockedIndividually = (userDocData?.unlockedTimestamps?.[id] || 0) + (24*60*60*1000) > Date.now();
            
            if (isPremium || isUnlockedIndividually) {
                openDetails(id);
                updateDoc(doc(db, "prompts", id), { unlockCount: increment(1) });
            } else {
                pendingUnlockId = id;
                document.getElementById('unlock-modal').classList.remove('hidden');
            }
        };

        window.buyPlan = async (days, cost) => {
            if (userDocData.coins >= cost) {
                const duration = days * 24 * 60 * 60 * 1000;
                const currentExpiry = userDocData.premiumExpiry || 0;
                const newStart = Math.max(currentExpiry, Date.now());
                const newExpiry = newStart + duration;

                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { 
                    coins: increment(-cost), 
                    premiumExpiry: newExpiry 
                });
                showToast(`Success! Premium Active for ${days} Days!`, "success");
            } else {
                showToast("Not enough coins! Invite friends.", "error");
            }
        };

        function openDetails(id) {
            const item = prompts.find(p => p.id === id);
            document.getElementById('d-img').src = item.image;
            document.getElementById('d-title').textContent = item.title;
            document.getElementById('d-cat').textContent = item.category;
            document.getElementById('d-prompt').textContent = item.prompt;
            document.getElementById('d-views').innerHTML = `<i class="fa-solid fa-eye text-[9px] mr-1"></i> ${item.unlockCount || 0} views`;
            
            const isFav = userDocData.favorites?.includes(id);
            const btn = document.getElementById('d-like-btn');
            btn.innerHTML = `<i class="${isFav ? 'fa-solid text-rose-500' : 'fa-regular text-white'} fa-heart text-sm"></i>`;
            btn.onclick = () => window.toggleFav({ stopPropagation: ()=>{} }, id);
            document.getElementById('detail-view').classList.remove('hidden');
        }

        window.closeDetails = () => document.getElementById('detail-view').classList.add('hidden');
        window.openCoinModal = () => showToast(`Balance: ${userDocData.coins} Coins`, "neutral");
        
        window.toggleFav = async (e, id) => {
            e.stopPropagation();
            const isFav = userDocData.favorites?.includes(id);
            const ref = doc(db, "users", currentUser.uid);
            if(isFav) {
                await updateDoc(ref, { favorites: arrayRemove(id) });
                showToast("Removed from Favorites", "neutral");
            } else {
                await updateDoc(ref, { favorites: arrayUnion(id) });
                showToast("Added to Favorites!", "success");
            }
        };

        window.copyPrompt = () => {
            navigator.clipboard.writeText(document.getElementById('d-prompt').textContent);
            showToast("Copied to clipboard!", "success");
        };
        
        window.copyRefLink = () => {
            const link = document.getElementById('ref-link').textContent;
            navigator.clipboard.writeText(link);
            showToast("Referral link copied!", "success");
        };

        function updateUI() {
            if(!userDocData) return;
            document.getElementById('profile-name').textContent = userDocData.firstName;
            if(currentUser.photo_url) document.getElementById('profile-img').src = currentUser.photo_url;
            
            document.getElementById('user-coins').textContent = userDocData.coins;
            document.getElementById('earn-balance').textContent = userDocData.coins;
            
            document.getElementById('ref-count').textContent = userDocData.referralCount || 0;
            document.getElementById('ref-earnings').textContent = userDocData.referralEarnings || 0;
            
            const isPrem = userDocData.premiumExpiry > Date.now();
            const badge = document.getElementById('profile-badge');
            const statusBadge = document.getElementById('user-status-badge');
            const subStatus = document.getElementById('sub-status');
            
            if(isPrem) {
                badge.classList.remove('hidden');
                statusBadge.textContent = "Premium";
                statusBadge.classList.replace('text-slate-500', 'text-amber-400');
                const daysLeft = Math.ceil((userDocData.premiumExpiry - Date.now()) / (1000 * 60 * 60 * 24));
                subStatus.textContent = `Premium Active (${daysLeft} days left)`;
                subStatus.className = "text-xs text-amber-400 mt-1 mb-4 font-bold";
            } else {
                badge.classList.add('hidden');
                statusBadge.textContent = "Free";
                statusBadge.classList.replace('text-amber-400', 'text-slate-500');
                subStatus.textContent = "No active plan";
                subStatus.className = "text-xs text-slate-500 mt-1 mb-4";
            }
            document.getElementById('ref-link').textContent = `https://t.me/${BOT_USERNAME}/app?startapp=ref_${currentUser.uid}`;
            renderHome();
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById(`view-${tab}`).classList.add('active-view');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-cyan-400', 'active', 'text-amber-500');
                btn.classList.add('text-slate-500');
            });
            
            const activeBtn = document.querySelector(`button[data-target="view-${tab}"]`);
            if(tab === 'earn') {
                activeBtn.classList.remove('text-slate-500'); 
                activeBtn.classList.add('text-amber-500', 'active');
            } else {
                activeBtn.classList.remove('text-slate-500'); 
                activeBtn.classList.add('text-cyan-400', 'active');
            }
            window.scrollTo(0,0);
        };
        
        window.filterCat = (cat) => {
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if(btn.dataset.cat === cat) {
                    btn.classList.add('bg-gradient-to-r', 'from-cyan-900/50', 'to-blue-900/50', 'text-cyan-400', 'border-cyan-500/50');
                    btn.classList.remove('text-slate-400', 'bg-[#1E293B]');
                } else {
                    btn.classList.remove('bg-gradient-to-r', 'from-cyan-900/50', 'to-blue-900/50', 'text-cyan-400', 'border-cyan-500/50');
                    btn.classList.add('text-slate-400', 'bg-[#1E293B]');
                }
            });
            renderHome();
        };

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.querySelector('span').textContent = msg;
            t.className = `fixed top-6 left-1/2 transform -translate-x-1/2 backdrop-blur-md px-5 py-3 rounded-2xl text-xs font-bold shadow-2xl flex items-center gap-2 transition-all duration-300 z-[90] ${type === 'error' ? 'bg-red-900/80 text-red-300 border border-red-500/30' : 'bg-slate-800/90 text-emerald-400 border border-emerald-500/30'}`;
            t.querySelector('i').className = type === 'error' ? 'fa-solid fa-circle-exclamation' : 'fa-solid fa-circle-check';
            t.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 2500);
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>